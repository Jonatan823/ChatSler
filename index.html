<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // Configuración Nodo Central SLER
    const firebaseConfig = {
        apiKey: "AIzaSyD5ItA76Xc7mmihQPC2AUCHQFStii4NAUg",
        authDomain: "sler-chat-lab.firebaseapp.com",
        databaseURL: "https://sler-chat-lab-default-rtdb.firebaseio.com",
        projectId: "sler-chat-lab",
        storageBucket: "sler-chat-lab.firebasestorage.app",
        messagingSenderId: "594954603335",
        appId: "1:594954603335:web:d332aa211e8ecce5521a62"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let urlDestino = ""; // Almacena a dónde quería ir el usuario

    // 1. FUNCIÓN PARA TUS BOTONES (Chat y Test)
    // Debes poner onclick="solicitarAcceso('URL')" en tus botones de la web oficial
    function solicitarAcceso(url) {
        const nickGuardado = localStorage.getItem('sler_nick');
        if (nickGuardado) {
            // Si ya existe, pasa directo con la llave en la URL
            window.location.href = url + "?authSler=" + nickGuardado;
        } else {
            // Si no existe, abrimos la aduana
            urlDestino = url;
            document.getElementById('sler-gate').style.display = 'flex';
        }
    }

    // 2. ACCIÓN DEL BOTÓN VALIDAR
    document.getElementById('btn-acceso-sler').onclick = function() {
        const nick = document.getElementById('gate-nick').value.trim();
        const status = document.getElementById('gate-status');

        if(!nick || nick.length < 3) {
            return alert("Por favor, ingresa un Nick válido (mínimo 3 caracteres).");
        }

        status.innerText = "Sincronizando con Bell Ville...";
        this.disabled = true;

        // Registro anónimo para crear el cliente en Firebase
        auth.signInAnonymously().then(res => {
            db.ref('usuarios/' + nick).set({
                nick: nick,
                origen: "sler_oficial_workstation",
                fecha_registro: firebase.database.ServerValue.TIMESTAMP,
                online: true
            }).then(() => {
                // Guardamos localmente para la triangulación
                localStorage.setItem('sler_nick', nick);
                // Redirigimos al destino original con la llave
                window.location.href = urlDestino + "?authSler=" + nick;
            });
        }).catch(e => {
            status.innerText = "Error de conexión.";
            this.disabled = false;
            console.error(e);
        });
    };
</script>
